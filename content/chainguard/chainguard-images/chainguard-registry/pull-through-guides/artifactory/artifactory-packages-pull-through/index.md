---
title: "How to Pull Packages from Chainguard Package Repositories through Artifactory"
linktitle: "Package Pull-through"
aliases: 
- /chainguard/chainguard-registry/pull-through-guides/artifactory/artifactory-packages-pull-through/
type: "article"
description: "Tutorial for setting up remote and virtual Artifactory repositories as pull-through caches for apk packages from Chainguard's package repositories."
date: 2024-11-14T15:56:52-07:00
lastmod: 2025-08-28T15:56:52-07:00
draft: false
tags: ["Chainguard Containers", "Procedural"]
images: []
menu:
  docs:
    parent: "artifactory"
toc: true
weight: 010
---

This tutorial details how to set up remote Alpine package (apk) repositories with [JFrog Artifactory](https://jfrog.com/artifactory/), which can provide pull-through caches for Chainguard package repositories. Specifically, this guide walks you through how to set up remote Artifactory repositories to serve as pull-through caches for a Chainguard private APK repository as well as Chainguard's public package repositories.

The guide then outlines how to configure a container image build to pull APK packages from these remote repositories using tokens generated by Artifactory. It also details how you can use a virtual repository from Artifactory to combine multiple remote repositories acting as a pull-through cache for Chainguard packages.


## Prerequisites

In order to complete this tutorial, you need the following:

* Administrative privileges over an Artifactory instance.
* [`chainctl`](/chainguard/chainctl-usage/how-to-install-chainctl/)
* Administrative privileges in your Chainguard organization to create role-bindings (`role_bindings.create`), for example as with [the `owner` role](/chainguard/administration/iam-organizations/roles-role-bindings/capabilities-reference/#chainguard-role-capabilities).


## Creating a Chainguard Pull Token for Remote Repository Authentication

When configuring an Artifactory remote repository to function as a pull-through cache for packages from a [Chainguard Private APK Repository](/chainguard/chainguard-images/features/private-apk-repos/), the remote repository must authenticate to Chainguard. This section outlines the steps necessary to create a Chainguard pull token and configure the required permissions to access your Chainguard organization's private APK repository:

Set your Chainguard organization identifier as an environment variable. Replace the `example.org` placeholder with your organization's name as it appears in the Chainguard Console:

```shell
export CHAINGUARD_ORG=example.org
```

Next, generate a pull token:

```shell
chainctl auth pull-token --parent=${CHAINGUARD_ORG} -o env
```

The command outputs the credentials as `export` commands you can run to set them as environment variables:

```output
export CHAINGUARD_IDENTITY_ID=<id>
export CHAINGUARD_TOKEN=<token>
```

Run the first of these commands to create an environment variable for the identity:

```shell
export CHAINGUARD_IDENTITY_ID=<id>
```

Be sure to note both the identity and token values to use when you create a remote Artifactory repository in the next section.

With the environment variables in place, create a role binding to grant the pull token identity the `apk.pull` role:

```shell
  chainctl iam role-bindings create \
    --parent=${CHAINGUARD_ORG} \
    --identity=${CHAINGUARD_IDENTITY_ID} \
    --role=apk.pull
```

This enables the identity to download packages from the private APK repository of the organization.


## Setting Up a Pull-Through Cache for a Private APK Repository

Now that you have an identity with permissions to do so, you can set up a remote Artifactory repository to reach your private APK repository from Chainguard. 

> **Note**: For more information on how to set up a remote repository in Artifactory, refer to [the official documentation](https://jfrog.com/help/r/jfrog-artifactory-documentation/remote-repositories). 

To set up the remote repository:

1. Log in to the JFrog platform.
2. Select the **Administration** tab near the top of the screen.
3. Select **Repositories** from the left-hand navigation menu.
4. On the Repositories page, click the **Create a Repository** button.
5. Select the **Remote** option.
6. In the **Select Package Type** window, select **Alpine**.

This takes you to a **Basic** configuration tab where you can enter the following details for the remote repository:

* **Repository Key** — This is a name used to identify your remote repository, for example `cg-private`.
* **URL** — This must be set to `https://apk.cgr.dev/${CHAINGUARD_ORG}`, but with your organization's actual name in place of `${CHAINGUARD_ORG}`. For example, if your organization is named `example` use `https://apk.cgr.dev/example`.
* **User Name** — This is used by Artifactory to authenticate to Chainguard and access your private APK repository. Use the pull token identity ID value you set to the `CHAINGUARD_IDENTITY_ID` variable.
* **Password / Access Token** — Enter the value from CHAINGUARD_TOKEN. 

Click the **Create Remote Repository** button to create the remote repository and return you to the **Repositories** page. 


### Generating a token for the remote repository

Before testing whether you're able to pull packages through the remote Artifactory repository, you must retrieve a token generated for it by Artifactory.

1. On the Repositories page, find your repository.
2. Click the ellipsis (**⋯**) all the way to the right of the repository's row.
3. Select **Set me up**. 
4. Click the **Generate Token & Create Instructions** button.
5. Copy or take note of the token generated for your repository.

With this token in hand, run the following `export` command to create an environment variable, replacing `my-token` with the token you noted down. You will use this environment variable in the following section as you test out the remote repository:

```shell
export CG_PRIVATE_TOKEN=my-token
```

Additionally, create two more environment variables to hold your Artifactory user profile and hostname:

```shell
export ARTIFACTORY_USER_PROFILE=my-user-profile
export ARTIFACTORY_HOSTNAME=my-artifactory-hostname
```

If you aren't sure of these values, you can find them in the command from the **Set Up An Alpine Client** window where you found the token:

```shell
sudo sh -c "echo 'https://linky:<TOKEN>@example-hostname.jfrog.io/artifactory/cg-private/<BRANCH>/<REPOSITORY>'" >> /etc/apk/repositories
```

In this example, the Artifactory user profile is `linky` and the hostname is `example-hostname`.

> **Note**: If your Artifactory user profile is an email address, you must percent-encode the `@` sign, as in `export ARTIFACTORY_USER_PROFILE=linky%40example.com`. Here, the Artifactory user profile is `linky@example.com`, but it must be entered into the environment variable as `linky%40example.com`. 


### Testing pull-through from private APK repository

This section outlines how to build a container image using a Chainguard image as a base and configure it to pull packages from the private APK repositories through your remote Artifactory repository.

Open a terminal and create a Dockerfile:

```shell
cat > Dockerfile <<EOF
FROM cgr.dev/chainguard/python:latest-dev
USER root
RUN mv /etc/apk/repositories /etc/apk/repositories.disabled
RUN echo 'https://$ARTIFACTORY_USER_PROFILE:$CG_PRIVATE_TOKEN@$ARTIFACTORY_HOSTNAME.jfrog.io/artifactory/cg-private/' >> /etc/apk/repositories
RUN apk add sed
USER nonroot
EOF
```

This Dockerfile uses the `python:latest-dev` image, but you can use any image which you have access to. However, because we are using `apk` a package from the `cg-private` remote repository in this Dockerfile, you should use an image that has this package manager available.

Note that this Dockerfile renames the default `/etc/apk/repositories` field. This isn't necessary, but doing so allows you to ensure that you're actually downloading packages from the remote Artifactory repositories instead of the default ones. 

Additionally, be aware that there are limitations to what packages are available from your organization's private APK repository. For instance, your organization may not have access to the `sed` package. Refer to our [private APK repository documentation](/chainguard/chainguard-images/features/private-apk-repos/#about-private-apk-repositories) for more information.

After creating the Dockerfile, build the image. Here, we tag the image `ar-build`:

```shell
docker build -t ar-build .
```

This command's output will show that the `sed` package was installed as expected:

```output
. . .
 => [4/4] RUN apk add sed                                                                2.8s
. . .
```

You can confirm this from the Artifactory dashboard with the [**Artifact Repository Browser**](https://jfrog.com/help/r/jfrog-artifactory-documentation/browsing-artifacts):

1. Navigate to the **Platform** tab.
2. Find **Artifactory** in the left-hand navigation menu.
3. Select **Artifacts**.
4. Find and expand the menu option for the `cg-private` Artifactory repository.

There, you will find the `npm` package listed, along with any other packages you've pulled through the remote repository.


## Configuring Pull-Through Caches for Chainguard's Public Repositories

You also have access to the public `chainguard` and `extra-packages` repositories. Also, because these repositories are public, they do not require authentication. To set up a pull-through cache for these package repositories on Artifactory, you can follow the same procedure outlined previously for the private APK repository.

You must create two remote repositories within Artifactory — one for each public package repo — by following the same steps as before. Enter the following details for these two remote repositories: 

* **Repository Key** — This is the name used to identify your remote repository. Again, you can choose whatever names you like here but this guide's examples use the names `cg-chainguard` and `cg-extras`.
* **URL** — This must be set to `https://virtualapk.cgr.dev/<ORGANIZATION-ID>/chainguard` for the `chainguard` repository and `https://virtualapk.cgr.dev/<ORGANIZATION-ID>/chainguard` for the `extra-packages` repository.
    * For both of these URLs, you need to replace the `<ORGANIZATION-ID>` placeholder with your Chainguard organization's UID. You can find this by running the `chainctl iam organizations list -o table`; the UID is the value in your organization's `ID` column. Alternatively, you can find it by checking the **Settings** ⇒ **General** page in the [Chainguard Console](https://console.chainguard.dev). 

You **do not** need to set any values for the **User Name** or **Password / Access Token** fields, as the public repositories do not require authentication. Keep all the remaining fields set to their default values and click the **Create Remote Repository** button. This creates the remote repository and return you to the **Repositories** page. 

After creating both repositories, generate and retrieve a token for each one as you did for the `cg-private` remote repository:

1. On the Repositories page, find both remote repositories you just created.
2. Click the ellipsis (**⋯**) all the way to the right of their respective rows.
3. Select **Set me up**. 
4. Click the **Generate Token & Create Instructions** button.
5. Copy or take note of the tokens generated for your repositories.

Next, copy the resulting tokens to create a pair of environment variables. For the `cg-chainguard` repository's token:

```shell
export CG_TOKEN=<cg-chainguard-token>
```

Then for the `cg-extras` repo's token:

```shell
export EXTRAS_TOKEN=<cg-extras-token>
```

Following that, you can use these environment variables, along with a few created earlier in the guide, to create a Dockerfile as you previously did for the `cg-private` repository:

```shell
cat > Dockerfile.repos <<EOF
FROM cgr.dev/chainguard/python:latest-dev
USER root
RUN mv /etc/apk/repositories /etc/apk/repositories.disabled
RUN echo 'https://$ARTIFACTORY_USER_PROFILE:$CG_TOKEN@$ARTIFACTORY_HOSTNAME.jfrog.io/artifactory/cg-chainguard/' >> /etc/apk/repositories
RUN echo 'https://$ARTIFACTORY_USER_PROFILE:$EXTRAS_TOKEN@$ARTIFACTORY_HOSTNAME.jfrog.io/artifactory/cg-extras/' >> /etc/apk/repositories
RUN apk add c-ares
EOF
```

Following that, build the image:

```shell
docker build -t ar-repos -f Dockerfile.repos .
```

As this command runs, it installs the `c-ares` package into the image.


## Using a Virtual Repository as a Pull-Through Cache

Artifactory allows you to create what it refers to as *virtual repositories*. A virtual repository is a collection of one or more repositories, such as local, remote, or other virtual repositories, that have the same package type. The benefit of this is that you can access resources from multiple locations using a single logical URL.

> **Note**: For more information on Artifactory's virtual repositories, please refer to the [official documentation](https://jfrog.com/help/r/jfrog-artifactory-documentation/virtual-repositories).

To get started, create a new virtual repository. 

1. Within Artifactory, navigate to the **Repositories** tab.
2. Click the **Create a Repository** button. 
3. Select the **Virtual** option.

, but instead of selecting the Alpine package type, select **Generic**.

You can use the Alpine package type, but [virtual Alpine repositories](https://jfrog.com/help/r/jfrog-artifactory-documentation/virtual-alpine-repositories) only allow you to pull packages that have already been cached by an associated remote repository. A **Generic** artifact repository provides more flexibility.

From the **New Virtual Repository** page, enter a key of your choosing into the **Repository Key** field.

Next, you must select existing repositories to include within this virtual repository. If you've been following along with this guide, you can test this out with the `cg-private, `cg-chainguard` and `cg-extras` repositories created previously.

Select your repositories by clicking their respective checkboxes. Then be sure to click the right-pointing chevron to move them to the **Selected Repositories** column. Finally, click the **Create Virtual Repository** button. 

Click the virtual repository's **Set Me Up** option to retrieve the token you'll need to test whether you can pull images through this repository. 

With this token in hand, create another environment variable:

```shell
export VIRTUAL_TOKEN=my-virtual-repo-token
```

You'll use this token to create one more Dockerfile in the next section.

### Testing pull-through with a virtual package repository

To test out the virtual repository, create a Dockerfile that configures an image to use it as outlined previously. You can test this out however you like, but here we stick to the example showing how to install a package into the built image:

```shell
cat > Dockerfile.virtual <<EOF
FROM cgr.dev/chainguard/python:latest-dev
USER root
RUN mv /etc/apk/repositories /etc/apk/repositories.disabled
RUN echo 'https://$ARTIFACTORY_USER_PROFILE:$VIRTUAL_TOKEN@$ARTIFACTORY_HOSTNAME.jfrog.io/artifactory/cg-apk-virt/' >> /etc/apk/repositories
RUN apk add stunnel
USER nonroot
EOF
```

After creating the Dockerfile, build the image:

```shell
docker build -t ar-virtual -f Dockerfile.virtual .
```

This example installs the `stunnel` package from the virtual repository as it builds the image.


## Debugging Pull-Through from Chainguard’s Package Repositories to Artifactory

If you run into issues when trying to pull from Chainguard's package repositories through Artifactory, you can try checking for these common pitfalls:

* You may run into issues if your Artifactory username is an email address; specifically, the `@` sign can lead to errors. Be sure that you're using a user profile with a name that only contains letters and numbers. If you must use a profile with an email address for a name, try percent-encoding the `@` sign by replacing it with `%40`.
* Ensure that all [network requirements](/chainguard/chainguard-images/network-requirements/) are met.
* When configuring a remote Artifactory repository, ensure that the **URL** field is set correctly. 
    * If necessary, ensure that you've set the correct UID for your organization in the URL field.
* It may help to [clear the Artifactory cache](https://jfrog.com/help/r/artifactory-cleanup-best-practices/clearing-an-oversized-cache).
* It could be that your Artifactory repository was misconfigured. In this case, create and configure a new Remote Artifactory repository to test with.


## Learn More

If you haven't already done so, you may find it useful to review our [Registry Overview](/chainguard/chainguard-registry/overview/) to learn more about Chainguard's registry. You can also learn more about Chainguard Containers by referring to our [documentation](/chainguard/chainguard-images/overview/), and learn more about working with the Chainguard platform by reviewing our [Administration documentation](/chainguard/administration/). If you'd like to learn more about JFrog Artifactory, we encourage you to refer to the [official Artifactory documentation](https://jfrog.com/help/r/jfrog-artifactory-documentation).
